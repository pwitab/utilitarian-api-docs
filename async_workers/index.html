



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Utilitarian Documentation">
      
      
      
        <meta name="author" content="Henrik Palmlund Wahlgren">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.2">
    
    
      
        <title>Async Workers - Utilitarian Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="white" data-md-color-accent="">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#async-workers" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Utilitarian Docs" class="md-header-nav__button md-logo">
          
            <img src="../images/u9n_badge_on_light.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Utilitarian Docs
            </span>
            <span class="md-header-nav__topic">
              Async Workers
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Utilitarian Docs" class="md-nav__button md-logo">
      
        <img src="../images/u9n_badge_on_light.svg" width="48" height="48">
      
    </a>
    Utilitarian Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Architecture
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Architecture
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../architecture/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../components/" title="Components" class="md-nav__link">
      Components
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../amr/" title="Automatic Meter Readings" class="md-nav__link">
      Automatic Meter Readings
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../protocols/" title="Protocols" class="md-nav__link">
      Protocols
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../meters/" title="Meters" class="md-nav__link">
      Meters
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../providers/" title="Providers" class="md-nav__link">
      Providers
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../open_source/" title="Open Source" class="md-nav__link">
      Open Source
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8" checked>
    
    <label class="md-nav__link" for="nav-8">
      On Premise
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        On Premise
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../installation/" title="Installation" class="md-nav__link">
      Installation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../component_settings/" title="Component Configuration" class="md-nav__link">
      Component Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docker_compose/" title="Setup using Docker Compose" class="md-nav__link">
      Setup using Docker Compose
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../using_https_on_api/" title="Use HTTPS" class="md-nav__link">
      Use HTTPS
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Async Workers
      </label>
    
    <a href="./" title="Async Workers" class="md-nav__link md-nav__link--active">
      Async Workers
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#queues" title="Queues" class="md-nav__link">
    Queues
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#list-of-queues" title="List of queues." class="md-nav__link">
    List of queues.
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workers" title="Workers" class="md-nav__link">
    Workers
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-a-worker" title="Run a worker" class="md-nav__link">
    Run a worker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimizing-workers" title="Optimizing workers" class="md-nav__link">
    Optimizing workers
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-worker-for-specific-queues" title="Start worker for specific queues" class="md-nav__link">
    Start worker for specific queues
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worker-concurrency" title="Worker concurrency" class="md-nav__link">
    Worker concurrency
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#beat" title="Beat" class="md-nav__link">
    Beat
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-the-beat-process" title="Run the beat process" class="md-nav__link">
    Run the beat process
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../amr_um/" title="Messaging" class="md-nav__link">
      Messaging
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Utilitarian API Reference
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Utilitarian API Reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../api_docs/v_1_2_0.html" title="v1.2.0" class="md-nav__link">
      v1.2.0
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api_docs/v_1_1_0.html" title="v1.1.0" class="md-nav__link">
      v1.1.0
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api_docs/v_1_0_0.html" title="v1.0.0" class="md-nav__link">
      v1.0.0
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../pwit/" title="PWIT AB" class="md-nav__link">
      PWIT AB
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#queues" title="Queues" class="md-nav__link">
    Queues
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#list-of-queues" title="List of queues." class="md-nav__link">
    List of queues.
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workers" title="Workers" class="md-nav__link">
    Workers
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-a-worker" title="Run a worker" class="md-nav__link">
    Run a worker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimizing-workers" title="Optimizing workers" class="md-nav__link">
    Optimizing workers
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-worker-for-specific-queues" title="Start worker for specific queues" class="md-nav__link">
    Start worker for specific queues
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worker-concurrency" title="Worker concurrency" class="md-nav__link">
    Worker concurrency
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#beat" title="Beat" class="md-nav__link">
    Beat
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-the-beat-process" title="Run the beat process" class="md-nav__link">
    Run the beat process
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="async-workers">Async Workers<a class="headerlink" href="#async-workers" title="Permanent link">#</a></h1>
<p>Most of the heavy lifting in Utilitarian is made in asynchronous worker processes 
outside of the request-response cycle of the Utilitarian API. Tasks are transported to 
workers using RabbitMQ.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We are using Celery to manage tasks and workers. You can learn a lot in their 
documentation on how to run and monitor tasks and workers.</p>
</div>
<h2 id="queues">Queues<a class="headerlink" href="#queues" title="Permanent link">#</a></h2>
<p>We separate different types of tasks on different queues. This makes you able to spin 
up more workers dedicated to certain queues depending on your load. It also enables you 
to lower your infrastructure bill since some queues used for AMR Tasks are only used 
daily or monthly depending on your AMR requirements. For example: you could just spin 
up the monthly amr task workers for the first day of the month to handle all the work. 
When all values have been collected you can shut it donw until next month.</p>
<p>If you start a worker without dedicated queues it will consume from all queues.</p>
<h3 id="list-of-queues">List of queues.<a class="headerlink" href="#list-of-queues" title="Permanent link">#</a></h3>
<ul>
<li>utilitarian.tasks.default</li>
<li>utilitarian.tasks.amr</li>
<li>utilitarian.tasks.amr.scheduled.quarterly</li>
<li>utilitarian.tasks.amr.scheduled.hourly</li>
<li>utilitarian.tasks.amr.scheduled.daily</li>
<li>utilitarian.tasks.amr.scheduled.monthly</li>
<li>utilitarian.tasks.amr.scheduled.yearly</li>
<li>utilitarian.tasks.amr.on_demand</li>
<li>utilitarian.tasks.commits</li>
<li>utilitarian.tasks.commits.meter_readings</li>
<li>utilitarian.tasks.commits.meter_system_events</li>
<li>utilitarian.tasks.external</li>
<li>utilitarian.tasks.external.publish</li>
<li>utilitarian.tasks.cleanup</li>
</ul>
<h2 id="workers">Workers<a class="headerlink" href="#workers" title="Permanent link">#</a></h2>
<p>A worker is a process that consumes tasks and execute them. Since the tasks are 
delivered via RabbitMQ you can split the processes up over several servers if you need 
to.
It is possible to run a worker with increased concurrency. That means that the process 
will spawn several subprocess' to process tasks concurrently. The concurrency settings 
are something that might need tuning since you want to maximize your server utilization 
of CPU and memory and depending on the type of tasks (the queues) the workers consumes 
the load on the server might differ. It all depends on what kind of meters Utilitarian 
is reading and how many meters and at what frequency the readings are made. Since this 
can vary very much from customer to customer we cannot give you exact numbers on how to 
set up you workers but we will help you optimize for you unique circumstances.</p>
<h3 id="run-a-worker">Run a worker<a class="headerlink" href="#run-a-worker" title="Permanent link">#</a></h3>
<p>We use the same docker image as the Utilitarian API, with all the same settings. 
If you are using docker-compose you define </p>
<div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">utilitarian-worker</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">quay.io/pwit/utilitarian:version</span>
    <span class="l l-Scalar l-Scalar-Plain">hostname</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">utilitarian-worker</span>
    <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">celery -A utilitarian worker --loglevel=INFO</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span> <span class="nv">*common_environment</span>  <span class="c1"># unpacks settings so you only have to define it once in the docker-compose</span>
</pre></div>


<h3 id="optimizing-workers">Optimizing workers<a class="headerlink" href="#optimizing-workers" title="Permanent link">#</a></h3>
<p>Depending on how you run Utilitarian, ie. what type of meter you use, how many etc, the 
load can look very different. That is why we split the work on separate queues so that 
it is possible to start more workers that just handle the high load queues </p>
<h4 id="start-worker-for-specific-queues">Start worker for specific queues<a class="headerlink" href="#start-worker-for-specific-queues" title="Permanent link">#</a></h4>
<p>Your can specify which queues the worker should consumer from at start-up by using the 
<code>-Q</code> option and give a comma separated list with queue names.</p>
<div class="codehilite"><pre><span></span>celery -A utilitarian worker -l info -Q utilitarian.tasks.amr.scheduled.quarterly,utilitarian.tasks.amr.on_demand
</pre></div>


<h4 id="worker-concurrency">Worker concurrency<a class="headerlink" href="#worker-concurrency" title="Permanent link">#</a></h4>
<p>Workers start up child processes to handle tasks concurrently. This defaults to the 
number of CPUs available on the system. But since most AMR task are I/O bound we could 
start up even more to process more tasks concurrently. </p>
<p>Exactly how many workers to run and how high the concurrency should be is something 
that is highly dependant on exacly how you use Utilitarian and you will have to 
experiment to find the best utilization of your resources. It is generally seen to be 
better to start more workers than keep on increasing concurrency.</p>
<p>You start a worker with specific concurrency using the <code>--concurrency</code> option</p>
<div class="codehilite"><pre><span></span>celery -A utilitarian worker -l info --concurrency=10
</pre></div>


<p>How high concurrency and the amount of workers is something you will have to weigh 
against yor need and budget (more workers might need more servers). It might be 
fine for you that daily polling tasks take a couple of hours to poll all meter. But if 
not start up more workers and increase concurrency higher concurrency. Just keep track 
of your memory and CPU utilization. </p>
<h2 id="beat">Beat<a class="headerlink" href="#beat" title="Permanent link">#</a></h2>
<p>The beat process is the scheduler for scheduled or periodic tasks. Utilitarian has a 
number of maintenance tasks that needs to be run at certain intervals. The beat process 
is keeping control of when a task was run last and initiates new tasks when they are 
scheduled. It is also the beat process that initiates scheduled polling of meter data 
from polled meters.</p>
<p>Only run one single beat process. If not you will end up with duplicate tasks. 
Duplicate tasks are usually ok, but will increase load on the system and might lead to 
higher operations costs such as data transfer cost.</p>
<h3 id="run-the-beat-process">Run the beat process<a class="headerlink" href="#run-the-beat-process" title="Permanent link">#</a></h3>
<div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">utilitarian-beat</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">quay.io/pwit/utilitarian:version</span>
    <span class="l l-Scalar l-Scalar-Plain">hostname</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">utilitarian-beat</span>
    <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">celery -A utilitarian beat --loglevel=INFO</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span> <span class="nv">*common_environment</span>  <span class="c1"># unpacks settings so you only have to define it once in the docker-compose</span>
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../using_https_on_api/" title="Use HTTPS" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Use HTTPS
              </span>
            </div>
          </a>
        
        
          <a href="../amr_um/" title="Messaging" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Messaging
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 Palmlund Wahlgren Innovative Technology AB
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/pwitab" class="md-footer-social__link fa fa-github"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.d9aa80ab.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>